<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StudyBuddy</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
  <h1>What can I help you study today?</h1>

  <div class="chat-container">
    <div id="chat-box" class="chat-box"></div>

    <div class="chat-input">
      <input type="text" id="user-input" placeholder="Ask a question, like 'Explain photosynthesis'..." />
      <button id="send-btn">â†‘</button>
    </div>
  </div>

  <div class="options">
    <button>Summarize Notes</button>
    <button>Explain a Concept</button>
    <button>Quiz Me</button>
    <button>Plan My Study Schedule</button>
  </div>

  <script>
    async function sendMessage(message) {
      if (!message) return;

      const chatBox = document.getElementById("chat-box");
      chatBox.classList.add("active");

      // Show user's message
      const userDiv = document.createElement("div");
      userDiv.className = "message user-message";
      userDiv.textContent = message;
      chatBox.appendChild(userDiv);

      // Show loading message
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "message bot-message loading";
      loadingDiv.textContent = "Bot is typing...";
      chatBox.appendChild(loadingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      // Send message to Flask
      const response = await fetch("/get", {
        method: "POST",
        body: new URLSearchParams({ user_message: message }),
      });

      const data = await response.json();

      // Remove loading message
      chatBox.removeChild(loadingDiv);

      // Show bot's reply
      const botDiv = document.createElement("div");
      botDiv.className = "message bot-message";
      botDiv.innerHTML = formatBotReply(data.response);
      chatBox.appendChild(botDiv);

      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function formatBotReply(text) {
      return marked.parse(text);
    }

    // Send on button click
    document.getElementById("send-btn").addEventListener("click", () => {
      const userInput = document.getElementById("user-input");
      const message = userInput.value.trim();
      sendMessage(message);
      userInput.value = "";
    });

    // Send on Enter key
    document.getElementById("user-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const message = e.target.value.trim();
        sendMessage(message);
        e.target.value = "";
      }
    });

    // Send on option button click
    document.querySelectorAll(".options button").forEach((button) => {
      button.addEventListener("click", () => {
        const message = button.textContent.trim();
        sendMessage(message);
      });
    });
  </script>
</body>
</html>